{% extends 'MyPage/base.html' %}
{% block content %}

<h3 class="border-bottom bottom-line">Chat with {{target.username}}</h3>
<div class="container">
    <ul id="chat-box" style="list-style: none; overflow: auto;">
    </ul>
</div>

<div class="container">
    <form id="chat_message">
        {% csrf_token %}
        Message:
        <div class="form-group">
            <input type="text"
            name="message"
            class="form-control"
            id="message"
            style="width: 50%;"
            onkeypress="return runScript(event)" 
            autocomplete="off" 
            maxlength="100"
            />
        </div>
    </form>
    <button id="send_button" class="btn btn-primary">Send</button>
</div>
<script>
    document.addEventListener('DOMContentLoaded', ()=>{
        // Sets the button up and loads the messages
        document.querySelector('#send_button').onclick = ()=>{
            send_message();
        }
        load_messages;

        // Load messages for every 1500 ms
        window.setInterval(load_messages, 1500);
    })

    // Runs when enter key is pressed
    function runScript(e) {
        if (e.keyCode == 13) {
            send_message();
            return false;
        }
    }

    // Gets the messages from the server and runs print_messages function
    function load_messages(){
        fetch("{% url 'my-chat-get' target.id %}")
        .then(response => response.json())
        .then(data => print_messages(data));
    }
    
    // Sends the message to the server to be added to the database
    function send_message(){
        form = new FormData(document.querySelector('#chat_message'));
        request = new XMLHttpRequest()
        request.open("POST", "{% url 'my-chat-send' target.id %}")
        request.onload = ()=>{
           load_messages();
           document.querySelector("#message").value = '';
        }
        request.send(form)
    }

    // Prints the messages
    function print_messages(data){
        var ul, li, i = 1;
        ul = document.querySelector('#chat-box');
        ul.innerHTML = '';
        var len = data.sent_messages.length
        for(message of data.sent_messages.reverse()){
            li = document.createElement('li');
            li.title=`${message.sent_by}: ${message.time_sent}`;

            if (message.sent_by == '{{ user.username }}'){
                if (len != i){
                    if(message['sent_by'] != data.sent_messages[i].sent_by || len == i){
                        li.innerHTML = `<img src="${message.sent_by_image}"`+
                        ` alt="No Profile Picture Set" class="rounded-circle chat_message_image">`;
                        
                    }
                    else{
                        li.innerHTML = '&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp';
                    }
                }
                else{
                    li.innerHTML = `<img src="${message.sent_by_image}"`+
                        ` alt="No Profile Picture Set" class="rounded-circle chat_message_image">`;
                }
                li.innerHTML += `&nbsp&nbsp${message.message}`;
                li.style.cssFloat = "left";
                li.style.textAlign = "left";
            }
            else{
                li.innerHTML = `${message['message']}`;
                if (len != i){
                    if(message.sent_by != data.sent_messages[i].sent_by){
                        li.innerHTML += `&nbsp&nbsp&nbsp<img src="${message.sent_by_image}" alt="No Profile Picture Set"`+
                        `  class="rounded-circle chat_message_image" title="${message.sent_by}: ${message.time_sent}">`;
                    }
                
                    else{
                        li.innerHTML += '&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp';
                    }
                }
                else{
                    li.innerHTML += `&nbsp&nbsp&nbsp<img src="${message.sent_by_image}" alt="No Profile Picture Set"`+
                        `  class="rounded-circle chat_message_image" title="${message.sent_by}: ${message.time_sent}">`;
                }
                li.style.cssFloat = "right";
                li.style.textAlign = "right";
            }
            
            ul.append(document.createElement('br'));
            ul.append(li);
            
            i++;   
        }
    }
</script>

{%endblock content %}